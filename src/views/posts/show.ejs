<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CP KKU Study Notes</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
<header class="topbar">
  <a class="brand" href="/">CP KKU STUDY NOTES</a>
  <nav>
    <a href="/">р╕лр╕Щр╣Йр╕▓р╕лр╕ер╕▒р╕Б</a>
    <a href="/search">р╕Др╣Йр╕Щр╕лр╕▓р╕кр╕гр╕╕р╕Ы</a>
    <a href="/community">р╕Юр╕╣р╕Фр╕Др╕╕р╕в</a>
    <% if (currentUser){ %>
      <a href="/notifications">р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ</a>
      <!-- <a href="/posts/new">+ р╣Вр╕Юр╕кр╕Хр╣Мр╕кр╕гр╕╕р╕Ы</a> --> 
      <!-- <a href="/threads/new">+ р╕Хр╕▒р╣Йр╕Зр╕Др╕│р╕Цр╕▓р╕б</a> --> 
      <% if (currentUser.role==='admin'){ %><a href="/admin">р╣Бр╕нр╕Фр╕бр╕┤р╕Щ</a><% } %>
      <form action="/logout" method="post" style="display:inline"><button class="linklike">р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ</button></form>
      <a href="/profile">р╣Вр╕Ыр╕гр╣Др╕Яр╕ер╣М (<%= currentUser.username %>)</a>
    <% } else { %>
      <a href="/login">р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ъ</a>
      <a href="/register">р╕кр╕бр╕▒р╕Др╕гр╕кр╕бр╕▓р╕Кр╕┤р╕Б</a>
    <% } %>
  </nav>
</header>
<main class="container">
<article class="post">
  <% if (post.coverImage){ %><img src="<%= post.coverImage %>" class="cover-xl"/><% } %>
  <h1><%= post.title %></h1>
  <p class="muted">р╣Вр╕Фр╕в <%= post.author?.username %> ┬╖ тЩе <%= post.likes.length %> ┬╖ ЁЯСБя╕П <%= post.views %></p>
  <div class="tags">
    <% (post.tags||[]).forEach(t=>{ %><span class="tag"><%= t %></span><% }) %>
  </div>
  <p><%= post.body %></p>
  <div class="row">
    <form method="post" action="/posts/<%= post.slug %>/like"><button>р╕Цр╕╣р╕Бр╣Гр╕И</button></form>
    <% if (currentUser && (currentUser.id === String(post.author._id) || currentUser.role==='admin')){ %>
      <a class="button" href="/posts/<%= post.slug %>/edit">р╣Бр╕Бр╣Йр╣Др╕В</a>
      <form method="post" action="/posts/<%= post.slug %>/delete"><button class="danger">р╕ер╕Ър╣Вр╕Юр╕кр╕Хр╣М</button></form>
    <% } else if (currentUser) { %>
      <a class="button" href="/posts/<%= post.slug %>/report">р╕гр╕▓р╕вр╕Зр╕▓р╕Щ</a>
    <% } %>
  </div> 
  <% if (currentUser) { %>
  <button id="save-post-btn" data-slug="<%= post.slug %>">
    <%= currentUser.savePosts && currentUser.savePosts.includes(String(post._id)) ? 'р╕вр╕Бр╣Ар╕ер╕┤р╕Бр╕Ър╕▒р╕Щр╕Чр╕╢р╕Б' : 'р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Вр╕Юр╕кр╕Хр╣М' %>
  </button>
<% } %>
  <hr/>
  <h3>р╕Др╕нр╕бр╣Ар╕бр╕Щр╕Хр╣М</h3>
  <ul class="comments">
    <% post.comments.forEach(c=>{ %>
      <li><b><%= c.author?.username %></b> <span class="muted"><%= new Date(c.createdAt).toLocaleString() %></span><br/><%= c.body %></li>
    <% }) %>
  </ul>
  <% if (currentUser){ %>
  <form method="post" action="/posts/<%= post.slug %>/comments">
    <textarea name="body" rows="3" required></textarea>
    <button>р╕кр╣Ир╕Зр╕Др╕нр╕бр╣Ар╕бр╕Щр╕Хр╣М</button>
  </form>
  <% } else { %><p class="muted">р╕Хр╣Йр╕нр╕Зр╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ър╣Ар╕Юр╕╖р╣Ир╕нр╕Др╕нр╕бр╣Ар╕бр╕Щр╕Хр╣М</p><% } %>
</article>
</main>
</body>
<script src="/js/save-post.js"></script>
</html>
